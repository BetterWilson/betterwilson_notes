# 第九章

## 9.1 datatime

### datatime格式获取时间信息

原始数据：

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
    'birthday': [
        datetime(2004,10,1),
        datetime(2000,11,27),
        datetime(2002,1,29),
        datetime(2002,8,27),
        datetime(2003,3,14),
        datetime(2002,12,17),
        datetime(2004,4,12),
    ]
}

frame = pd.DataFrame(data)
print(frame)
----------------------------------------------------------------------------------------
     ID name  gender  height  age   birthday
0  0001   张三    True    1.88   16 2004-10-01
1  0002   李四   False    1.78   20 2000-11-27
2  0003   王五    True    1.81   18 2002-01-29
3  0004   赵六   False    1.86   18 2002-08-27
4  0005  张张三    True    1.74   17 2003-03-14
5  0006  李李四   False    1.75   18 2002-12-17
6  0007  王王五    True    1.76   16 2004-04-12
```

```python
# datatime对象.year/month/day/now_time.weekday()	年/月/日/星期(周一是0周日是6)
now_time = datetime.now()
print(now_time.year, now_time.month, now_time.day, now_time.weekday())
----------------------------------------------------------------------------------------
2024 12 22 6

# frame['birthday'].dt.year/month/day	年/月/日
print(frame['birthday'].dt.year)
----------------------------------------------------------------------------------------
0    2004
1    2000
2    2002
3    2002
4    2003
5    2002
6    2004
```

### 格式转换

原始数据：

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
    'birthday': [
        '2004-10-01',
        '2000-11-27',
        '2002-01-29',
        '2002-08-27',
        '2003-03-14',
        '2002-12-17',
        '2004-04-12',
    ]
}

frame = pd.DataFrame(data)
print(frame)
----------------------------------------------------------------------------------------
     ID name  gender  height  age    birthday
0  0001   张三    True    1.88   16  2004-10-01
1  0002   李四   False    1.78   20  2000-11-27
2  0003   王五    True    1.81   18  2002-01-29
3  0004   赵六   False    1.86   18  2002-08-27
4  0005  张张三    True    1.74   17  2003-03-14
5  0006  李李四   False    1.75   18  2002-12-17
6  0007  王王五    True    1.76   16  2004-04-12
```

#### 标准

```python
# to_datetime函数将字符串对象（例如年-月-日或日-月-年）转换为datatime对象
print(pd.to_datetime(frame['birthday']))
----------------------------------------------------------------------------------------
0   2004-10-01
1   2000-11-27
2   2002-01-29
3   2002-08-27
4   2003-03-14
5   2002-12-17
6   2004-04-12
```

#### 非标准

原始数据：

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
    'birthday': [
        '2004年-10-01',
        '2000年-11-27',
        '2002年-01-29',
        '2002年-08-27',
        '2003年-03-14',
        '2002年-12-17',
        '2004年-04-12',
    ]
}
frame = pd.DataFrame(data)
```

##### strptime

string parse time，从字符串转为datatime对象

```python
# Series对象.apply(datetime.strptime, args=["%Y年-%m-%d"])
# args=["%Y年-%m-%d"]表示如何解析非标准的原始字符串数据
print(frame['birthday'].apply(datetime.strptime, args=["%Y年-%m-%d"]))
----------------------------------------------------------------------------------------
0   2004-10-01
1   2000-11-27
2   2002-01-29
3   2002-08-27
4   2003-03-14
5   2002-12-17
6   2004-04-12
```

##### strftime

string format time，格式化datatime对象(要求原始时间数据是datatime类型，此函数仅用于表示)

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
    'birthday': [
        '2004-10-01',
        '2000-11-27',
        '2002-01-29',
        '2002-08-27',
        '2003-03-14',
        '2002-12-17',
        '2004-04-12',
    ]
}
frame = pd.DataFrame(data)
frame['birthday'] = pd.to_datetime(frame['birthday'])
print(frame['birthday'].apply(datetime.strftime, args=["%d/%m/%Y"]))
----------------------------------------------------------------------------------------
0    01/10/2004
1    27/11/2000
2    29/01/2002
3    27/08/2002
4    14/03/2003
5    17/12/2002
6    12/04/2004
```

#### timedelta函数

```python
import pandas as pd
from datetime import timedelta

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
    'birthday': [
        '2004-10-01',
        '2000-11-27',
        '2002-01-29',
        '2002-08-27',
        '2003-03-14',
        '2002-12-17',
        '2004-04-12',
    ]
}
frame = pd.DataFrame(data)
print(pd.to_datetime(frame['birthday']) + timedelta(days=-1))	# timedelta(days=-1)让时间减一天
----------------------------------------------------------------------------------------
0   2004-09-30
1   2000-11-26
2   2002-01-28
3   2002-08-26
4   2003-03-13
5   2002-12-16
6   2004-04-11
```



## 9.2 时间索引

#### 建立时间索引

`pd.DataFrame(data, index=my_time)`通过传参index来指定dataframe的索引值

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
}

my_time = [
    datetime(2004, 10, 1),
    datetime(2000, 11, 27),
    datetime(2002, 1, 29),
    datetime(2002, 8, 27),
    datetime(2003, 3, 14),
    datetime(2002, 12, 17),
    datetime(2004, 4, 12),
]

frame = pd.DataFrame(data, index=my_time)
print(frame)
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2004-10-01  0001   张三    True    1.88   16
2000-11-27  0002   李四   False    1.78   20
2002-01-29  0003   王五    True    1.81   18
2002-08-27  0004   赵六   False    1.86   18
2003-03-14  0005  张张三    True    1.74   17
2002-12-17  0006  李李四   False    1.75   18
2004-04-12  0007  王王五    True    1.76   16
```

#### 时间索引行检索

```python
# 以下三种所得结果相同，注意：使用第二种时，年占4位，月和日都占2位，例如2004年10月1日需要写成20041001
print(frame.loc[datetime(2004, 10, 1)])
print(frame.loc['20041001'])
print(frame.loc['2004-10-1'])
----------------------------------------------------------------------------------------
ID        0001
name        张三
gender    True
height    1.88
age         16

# frame.loc['2002-1-29':'2004-10-1']使用切片获取目标内的所有数据（需要保障索引值是单调增/减）
frame.sort_index(inplace=True)
print(frame.loc['2002-1-29':'2004-10-1'])
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2002-01-29  0003   王五    True    1.81   18
2002-08-27  0004   赵六   False    1.86   18
2002-12-17  0006  李李四   False    1.75   18
2003-03-14  0005  张张三    True    1.74   17
2004-04-12  0007  王王五    True    1.76   16
2004-10-01  0001   张三    True    1.88   16
```

#### 时间索引分组

```python
# groupby函数指定参数level=0，表示对索引分组
print(frame['ID'].groupby(level=0).count())
----------------------------------------------------------------------------------------
2000-11-27    1
2002-01-29    1
2002-08-27    1
2002-12-17    1
2003-03-14    1
2004-04-12    1
2004-10-01    1
```

时间索引对于分组的便利：



## 9.3 时间序列

原始数据：

```python
import pandas as pd

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
}
frame = pd.DataFrame(data)
print(frame)
----------------------------------------------------------------------------------------
     ID name  gender  height  age
0  0001   张三    True    1.88   16
1  0002   李四   False    1.78   20
2  0003   王五    True    1.81   18
3  0004   赵六   False    1.86   18
4  0005  张张三    True    1.74   17
5  0006  李李四   False    1.75   18
6  0007  王王五    True    1.76   16
```

#### pd.date_range()

```python
# pd.date_range()函数，生成指定时间起止的时间序列，指定时间点
frame = pd.DataFrame(data, pd.date_range('2020-1-1', '2020-1-7'))
# 也可以写成frame = pd.DataFrame(data, pd.date_range(start='2020-1-1', periods=7))
print(frame)
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2020-01-01  0001   张三    True    1.88   16
2020-01-02  0002   李四   False    1.78   20
2020-01-03  0003   王五    True    1.81   18
2020-01-04  0004   赵六   False    1.86   18
2020-01-05  0005  张张三    True    1.74   17
2020-01-06  0006  李李四   False    1.75   18
2020-01-07  0007  王王五    True    1.76   16

# 添加参数freq='M'，按每月月底的日期生成时间序列（freq='MS':月初;'2M':两个月取一次;'1h30min':一个半小时取一次）
frame = pd.DataFrame(data, pd.date_range(start='2020-1-1', periods=7, freq='M'))
print(frame)
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2020-01-31  0001   张三    True    1.88   16
2020-02-29  0002   李四   False    1.78   20
2020-03-31  0003   王五    True    1.81   18
2020-04-30  0004   赵六   False    1.86   18
2020-05-31  0005  张张三    True    1.74   17
2020-06-30  0006  李李四   False    1.75   18
2020-07-31  0007  王王五    True    1.76   16
```

#### pd.period_range()

```python
# pd.period_range()函数，为时间段索引序列
frame = pd.DataFrame(data, pd.period_range(start='2020-1', end='2020-7', freq='M'))
# 也可以写成frame = pd.DataFrame(data, pd.period_range(start='2020-1', periods=7, freq='M'))
print(frame)
----------------------------------------------------------------------------------------
           ID name  gender  height  age
2020-01  0001   张三    True    1.88   16
2020-02  0002   李四   False    1.78   20
2020-03  0003   王五    True    1.81   18
2020-04  0004   赵六   False    1.86   18
2020-05  0005  张张三    True    1.74   17
2020-06  0006  李李四   False    1.75   18
2020-07  0007  王王五    True    1.76   16
```

#### pd.PeriodIndex()

```python
# pd.PeriodIndex()函数指定时间段（可以不连续）freq='M'表示月，也可以写成freq='Y'表示年
values = ['2019-12', '2020-2', '2019-11', '2020-02', '2019-12', '2020-01', '2019-07']
frame = pd.DataFrame(data, pd.PeriodIndex(values, freq='M'))
print(frame)
----------------------------------------------------------------------------------------
        ID name  gender  height  age
2019  0001   张三    True    1.88   16
2020  0002   李四   False    1.78   20
2019  0003   王五    True    1.81   18
2020  0004   赵六   False    1.86   18
2019  0005  张张三    True    1.74   17
2020  0006  李李四   False    1.75   18
2019  0007  王王五    True    1.76   16

# pd.PeriodIndex()传参freq='Q'表示将月份映射成季度
values = ['2019-12', '2020-2', '2019-11', '2020-02', '2019-12', '2020-01', '2019-07']
frame = pd.DataFrame(data, pd.PeriodIndex(values, freq='Q'))
print(frame)
----------------------------------------------------------------------------------------
          ID name  gender  height  age
2019Q4  0001   张三    True    1.88   16
2020Q1  0002   李四   False    1.78   20
2019Q4  0003   王五    True    1.81   18
2020Q1  0004   赵六   False    1.86   18
2019Q4  0005  张张三    True    1.74   17
2020Q1  0006  李李四   False    1.75   18
2019Q3  0007  王王五    True    1.76   16

# 也可以反过来映射，将季度映射成月份，此时传参freq='M'
values = ['2019Q4', '2020Q1', '2019Q4', '2020Q1', '2019Q4', '2020Q1', '2019Q3']
frame = pd.DataFrame(data, pd.PeriodIndex(values, freq='M'))
print(frame)
----------------------------------------------------------------------------------------
           ID name  gender  height  age
2019-10  0001   张三    True    1.88   16
2020-01  0002   李四   False    1.78   20
2019-10  0003   王五    True    1.81   18
2020-01  0004   赵六   False    1.86   18
2019-10  0005  张张三    True    1.74   17
2020-01  0006  李李四   False    1.75   18
2019-07  0007  王王五    True    1.76   16

# 还可以指定年和月
year = [2019, 2020, 1029, 2020, 2019, 2020, 1019]
month = [12, 1, 11, 2, 12, 1, 7]
frame = pd.DataFrame(data, pd.PeriodIndex(year=year, month=month, freq='M'))
print(frame)
----------------------------------------------------------------------------------------
           ID name  gender  height  age
2019-12  0001   张三    True    1.88   16
2020-01  0002   李四   False    1.78   20
1029-11  0003   王五    True    1.81   18
2020-02  0004   赵六   False    1.86   18
2019-12  0005  张张三    True    1.74   17
2020-01  0006  李李四   False    1.75   18
1019-07  0007  王王五    True    1.76   16
```

## 9.4 不同颗粒度时间信息转换

原始数据：

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
}

dates = [
    datetime(2019, 11, 29),
    datetime(2019, 12, 5),
    datetime(2019, 12, 17),
    datetime(2019, 12, 30),
    datetime(2020, 1, 1),
    datetime(2020, 1, 3),
    datetime(2020, 1, 4),
]

frame = pd.DataFrame(data, index=dates)
print(frame)
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2019-11-29  0001   张三    True    1.88   16
2019-12-05  0002   李四   False    1.78   20
2019-12-17  0003   王五    True    1.81   18
2019-12-30  0004   赵六   False    1.86   18
2020-01-01  0005  张张三    True    1.74   17
2020-01-03  0006  李李四   False    1.75   18
2020-01-04  0007  王王五    True    1.76   16
```

#### to_period()

```python
# to_period函数参数freq='A-AUG'指将每年8月设置为最后一个月，即2019年11月设置为为2020年；
print(frame.to_period(freq='A-AUG'))
----------------------------------------------------------------------------------------
        ID name  gender  height  age
2020  0001   张三    True    1.88   16
2020  0002   李四   False    1.78   20
2020  0003   王五    True    1.81   18
2020  0004   赵六   False    1.86   18
2020  0005  张张三    True    1.74   17
2020  0006  李李四   False    1.75   18
2020  0007  王王五    True    1.76   16


```

#### to_timestamp()

```python
# frame.to_timestamp()将时间索引转换为日期，默认重置为每月1号(默认how='start‘)
frame = frame.to_period(freq='M')
print(frame.to_timestamp())
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2019-11-01  0001   张三    True    1.88   16
2019-12-01  0002   李四   False    1.78   20
2019-12-01  0003   王五    True    1.81   18
2019-12-01  0004   赵六   False    1.86   18
2020-01-01  0005  张张三    True    1.74   17
2020-01-01  0006  李李四   False    1.75   18
2020-01-01  0007  王王五    True    1.76   16

# frame.to_timestamp(how='end')重置为每月最后一天最后一秒
print(frame.to_timestamp(how='end'))
----------------------------------------------------------------------------------------
                                 ID name  gender  height  age
2019-11-30 23:59:59.999999999  0001   张三    True    1.88   16
2019-12-31 23:59:59.999999999  0002   李四   False    1.78   20
2019-12-31 23:59:59.999999999  0003   王五    True    1.81   18
2019-12-31 23:59:59.999999999  0004   赵六   False    1.86   18
2020-01-31 23:59:59.999999999  0005  张张三    True    1.74   17
2020-01-31 23:59:59.999999999  0006  李李四   False    1.75   18
2020-01-31 23:59:59.999999999  0007  王王五    True    1.76   16
```

#### asfreq()

```python
# asfreq(freq='D')表示细化颗粒度到天；freq='T'表示小时；freq='A'表示年
frame = frame.to_period(freq='M')
print(frame.asfreq(freq='D', how='end'))
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2019-11-30  0001   张三    True    1.88   16
2019-12-31  0002   李四   False    1.78   20
2019-12-31  0003   王五    True    1.81   18
2019-12-31  0004   赵六   False    1.86   18
2020-01-31  0005  张张三    True    1.74   17
2020-01-31  0006  李李四   False    1.75   18
2020-01-31  0007  王王五    True    1.76   16
```

## 9.5 时间采样

原始数据：

```python
import pandas as pd
from datetime import datetime

data = {
    'ID': ['0001', '0002', '0003', '0004', '0005', '0006', '0007'],
    'name': ['张三', '李四', '王五', '赵六', '张张三', '李李四', '王王五'],
    'gender': [True, False, True, False, True, False, True],
    'height': [1.88, 1.78, 1.81, 1.86, 1.74, 1.75, 1.76],
    'age': [16, 20, 18, 18, 17, 18, 16],
}

dates = [
    datetime(2019, 11, 29),
    datetime(2019, 12, 5),
    datetime(2019, 12, 17),
    datetime(2019, 12, 30),
    datetime(2020, 1, 1),
    datetime(2020, 1, 3),
    datetime(2020, 1, 4),
]

frame = pd.DataFrame(data, index=dates)
print(frame)
----------------------------------------------------------------------------------------
              ID name  gender  height  age
2019-11-29  0001   张三    True    1.88   16
2019-12-05  0002   李四   False    1.78   20
2019-12-17  0003   王五    True    1.81   18
2019-12-30  0004   赵六   False    1.86   18
2020-01-01  0005  张张三    True    1.74   17
2020-01-03  0006  李李四   False    1.75   18
2020-01-04  0007  王王五    True    1.76   16
```

#### resample()

```python
# frame['height'].resample('M').mean()表示按月份计算身高平均值
print(frame['height'].resample('M').mean())
----------------------------------------------------------------------------------------
2019-11-30    1.880000
2019-12-31    1.816667
2020-01-31    1.750000

# resample()函数添加参数kind='period'表示只显示到月份
print(frame['height'].resample('M', kind='period').mean())
----------------------------------------------------------------------------------------
2019-11    1.880000
2019-12    1.816667
2020-01    1.750000

# frame['height'].resample('H').mean()表示细化颗粒度，将每天的时间细分为24小时，但均值身高只显示一次，其余的用NaN填充
print(frame['height'].resample('H').mean())
----------------------------------------------------------------------------------------
2019-11-29 00:00:00    1.88
2019-11-29 01:00:00     NaN
2019-11-29 02:00:00     NaN
2019-11-29 03:00:00     NaN
2019-11-29 04:00:00     NaN
                       ... 
2020-01-03 20:00:00     NaN
2020-01-03 21:00:00     NaN
2020-01-03 22:00:00     NaN
2020-01-03 23:00:00     NaN
2020-01-04 00:00:00    1.76

# frame['height'].resample('H').ffill()使用上一级时间颗粒度对应的数值来填充
print(frame['height'].resample('H').ffill())
----------------------------------------------------------------------------------------
2019-11-29 00:00:00    1.88
2019-11-29 01:00:00    1.88
2019-11-29 02:00:00    1.88
2019-11-29 03:00:00    1.88
2019-11-29 04:00:00    1.88
                       ... 
2020-01-03 20:00:00    1.75
2020-01-03 21:00:00    1.75
2020-01-03 22:00:00    1.75
2020-01-03 23:00:00    1.75
2020-01-04 00:00:00    1.76

# frame['height'].resample('H').ffill(limit=2)限制填充范围：只填充后两个数据
print(frame['height'].resample('H').ffill(limit=2))
----------------------------------------------------------------------------------------
2019-11-29 00:00:00    1.88
2019-11-29 01:00:00    1.88
2019-11-29 02:00:00    1.88
2019-11-29 03:00:00     NaN
2019-11-29 04:00:00     NaN
                       ... 
2020-01-03 20:00:00     NaN
2020-01-03 21:00:00     NaN
2020-01-03 22:00:00     NaN
2020-01-03 23:00:00     NaN
2020-01-04 00:00:00    1.76

# resample()函数传参closed='right'表示右闭区间
print(frame['height'].resample('H', closed='right').mean())
----------------------------------------------------------------------------------------
2019-11-28 23:00:00    1.88
2019-11-29 00:00:00     NaN
2019-11-29 01:00:00     NaN
2019-11-29 02:00:00     NaN
2019-11-29 03:00:00     NaN
                       ... 
2020-01-03 19:00:00     NaN
2020-01-03 20:00:00     NaN
2020-01-03 21:00:00     NaN
2020-01-03 22:00:00     NaN
2020-01-03 23:00:00    1.76
```















